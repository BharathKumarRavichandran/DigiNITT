<%include partials/studentHeader%>
<style>
iframe {
    overflow: scroll;
    width: 100%;
    height: 100%;
    border: 1px solid black;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<div style="display: none;" id="workflowData">
    <%= JSON.stringify(workflow) %>
</div>

<span style="display: none;" id="hidden-pieValueCompleted">></span>
<span style="display: none;" id="hidden-pieValueNotCompleted"></span>
<div class="animated fadeIn">
    <div class="row text-center">
        <div class="col-lg-6">
            <iframe scrolling="yes" width="100%" height="800px" srcdoc='
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <meta http-equiv="X-UA-Compatible" content="ie=edge">
                    <title>Generated Certificate</title>
                </head>
                <body>
                    <p style="font-size: x-small;">Time: ..........</p>
                    <div style="margin: 5rem 1rem;">
                        <h1 style="text-align: center;">Bonafide Certificate</h1>
                        <p style="font-size:x-large">This is to certify that <b>.......</b>, S/O or D/O <b>........</b> bearing Roll Number <b>......</b> is a
                        bonafide student of National Institute of Technology, Tiruchirappalli, pursuing
                        <b>.........</b> in <b>..........</b>, currently <b>........</b> year, <b>.........</b> semester. </p>
                    </div>
                    .......QR......
                </body>
                </html>'>
            </iframe>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <div id="form-title">
                    </div>
                </div>
                <div class="card-body card-block">
                    <div>
                        <div id="fieldContainer">
                        </div>
                        </br>
                        <div id="designatorContainer">
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary btn-sm" onclick="submitMe()">
                        <i class="fa fa-dot-circle-o"></i> Submit
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let data = document.getElementById("workflowData").innerHTML;
        data = JSON.parse(data)
        console.log(data)
        let fieldSize = data.fields.length;
        let fields = [];

        for (let i = 0; i < fieldSize; i++) {
            let childElem = "<label for='" + data.fields[i] + "' class='form-control-label'>" + data.fields[i] + "</label><input type='text' id='" + data.fields[i] + "' name='" + data.fields[i] + "' placeholder='" + data.fields[i] + "' class='form-control inp'>";
            $(childElem).appendTo("#fieldContainer")
        }

        let designatorsSize = data.approvers.length
        let idx = window.location.host.length + 15 + 2 + window.location.protocol.length
        console.log("workflowId", window.location.href.slice(idx + 1, window.location.href.length))
        let workflowId = window.location.href.slice(idx + 1, window.location.href.length);

        for (let i = 0; i < designatorsSize; i++) {
            let istr = i.toString();

            let chooseDesignatorElem = "<div style='display: flex; justify-content: space-around'><label for='" + data.approvers[i].grp.name.replace(/\s+/, "") + "' class='form-control-label'>" + data.approvers[i].grp.name.replace(/\s+/, "") + "</label><select id='" + data.approvers[i].grp.name.replace(/\s+/, "") + "'>";

            let members = data.approvers[i].grp.members.length;
            for (let j = 0; j < members; j++) {
                let person = "<option class='" + data.approvers[i].grp.members[j]._id + "'value='" + data.approvers[i].grp.members[j].name.replace(/\s+/, "") + "' id='" + data.approvers[i].grp.members[j].name.replace(/\s+/, "") + "'>" + data.approvers[i].grp.members[j].name.replace(/\s+/, "") + "</option>";
                chooseDesignatorElem += person;
            }

            chooseDesignatorElem += "</select></div></br>";
            $(chooseDesignatorElem).appendTo("#designatorContainer");
        }

        function submitMe() {

            let approverIds = [];
            let approvedNames = [];
            let approvers;

            for (let i = 0; i < designatorsSize; i++) {
                let myselect = "#" + data.approvers[i].grp.name.replace(/\s+/, "") + " option:selected";
                approvedNames.push($(myselect).text().replace(/\s+/, ""))
                approverIds.push(document.getElementById(approvedNames[i]).className);
            }

            for (let i = 0; i < designatorsSize; i++) {
                if (i === 0) {
                    approvers = [
                        {
                            approverId: approverIds[i],
                            level: i
                        }
                    ]
                }
                else {
                    approvers.push({
                        approverId: approverIds[i],
                        level: i
                    })
                }
            }

            for (let i = 0; i < fieldSize; i++) {
                fields.push(document.getElementById(data.fields[i]).value)
                console.log("TCL: submitMe -", data.fields[i])
            }
            console.log(workflowId)
            console.log(approvers)
            console.log(fields)

            let url = (window.location.protocol + "//" + window.location.host + "/request/create");
            $.post(url, {
                workflowId: workflowId,
                approvers: approvers,
                fields: fields

            }, function (data, status) {
                console.log(data, status);
                window.location.href = '/';
            });
        }

    </script>
    <%include partials/footer%>